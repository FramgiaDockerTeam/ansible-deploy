- name: Enable UTF-8
  locale_gen: name=en_US.UTF-8 state=present

- name: Add MariaDb key
  apt_key: keyserver=keyserver.ubuntu.com id=0xcbcb082a1bb943db
  run_once: true

- name: Add Nodesource key
  apt_key: url=https://deb.nodesource.com/gpgkey/nodesource.gpg.key state=present
  run_once: true

- name: Add APT repositories
  apt_repository: repo={{item}} state=present
  with_items:
    - "deb [arch=amd64,i386,ppc64el] http://ftp.yz.yamagata-u.ac.jp/pub/dbms/mariadb/repo/10.1/ubuntu trusty main"
    - "ppa:ondrej/php"
    - "deb https://deb.nodesource.com/node_6.x {{ ansible_distribution_release|lower }} main"
  run_once: true

- name: Install packages
  apt: name={{ item }} update_cache=yes state=present
  with_items:
    - git
    - curl
    - mcrypt
    - build-essential
    - nginx
    - mariadb-server
    - php5.6-cli
    - php5.6-curl
    - php5.6-fpm
    - php5.6-intl
    - php5.6-json
    - php5.6-xml
    - php5.6-mbstring
    - php5.6-mcrypt
    - php5.6-zip
    - php5.6-mysql
    - nodejs
  notify:
    - start php-fpm
    - start nginx
    - start mysql
  run_once: true

- name: Install npm build tool
  npm: name={{ item }} state=present global=yes
  become: yes
  with_items:
    - npm
    - n
    - bower
    - gulp
  run_once: true

- name: Download Composer installer.
  get_url: url=https://getcomposer.org/installer dest=/tmp/composer-installer.php mode=0755
  run_once: true

- name: Run Composer installer.
  command: >
    php composer-installer.php
    chdir=/tmp
    creates=/usr/local/bin/composer
  run_once: true

- name: Move Composer into globally-accessible location
  shell: >
    mv /tmp/composer.phar /usr/local/bin/composer
    creates=/usr/local/bin/composer
  notify: start php-fpm
  run_once: true